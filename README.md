# Dynamic Occupancy Models for Steppe Birds in Spain

Multi-species dynamic occupancy analysis of four steppe bird species using eBird citizen science data and remotely-sensed environmental covariates.

## Species

| Code | Scientific Name | Common Name (EN) |
|------|----------------|-------------------|
| `otitar` | *Otis tarda* | Great Bustard |
| `ptealc` | *Pterocles alchata* | Pin-tailed Sandgrouse |
| `pteori` | *Pterocles orientalis* | Black-bellied Sandgrouse |
| `tettet` | *Tetrax tetrax* | Little Bustard |

## Overview

This project fits **dynamic occupancy models** (`unmarked::colext`) to estimate occupancy, colonisation, and extinction probabilities for four threatened steppe bird species across Spain (2017-2022). Data come from the eBird Basic Dataset, with environmental covariates from WorldClim, MODIS (via Google Earth Engine), and TerraClimate. Model predictions are validated against the Spanish Biodiversity Atlas using spatial block cross-validation.

## Repository Structure

```
dynamic_occupancy_models_steppe_birds/
├── R/                          # Core R functions and pipeline
│   ├── run_all.R               # ONE COMMAND to run full pipeline
│   ├── check_repro.R           # Smoke test: verify environment
│   └── model_configs.R         # Species-specific model formulas
├── scripts/                    # Analysis pipeline (numbered steps)
│   ├── 1_prepare_database_ebird.R
│   ├── 2_prepare_static_variables.R
│   ├── 3_prepare_dynamic_variables.R
│   ├── 3_download_dynamic_variables_{sp}.js  (GEE, x4 species)
│   ├── 4_occupancy_models.R
│   └── 5_validation.R
├── data/                       # Data (raw = immutable, processed = generated)
│   ├── raw/                    # Place raw data here (see data-raw/get_data.R)
│   └── processed/              # Generated by pipeline
├── data-raw/
│   └── get_data.R              # Instructions to obtain raw data
├── figs/                       # Generated figures (PNG)
├── results/                    # Generated outputs (model summaries, GOF, CSV)
├── docs/                       # Additional documentation
├── renv.lock                   # Locked package versions
├── REPRODUCIBILITY.md          # Full reproducibility guide
├── guille_feedback.md           # Review notes and changelog
└── .gitignore
```

## Quick Start

### Prerequisites
- **R >= 4.3** with system libraries for `sf`/`terra` (GDAL, GEOS, PROJ)
- **Google Earth Engine account** (for step 3a only)
- **Raw data** placed in `data/raw/` (see instructions below)

### Setup

```bash
# Clone
git clone https://github.com/<user>/dynamic_occupancy_models_steppe_birds.git
cd dynamic_occupancy_models_steppe_birds

# Install exact R packages
Rscript -e 'renv::restore()'

# Verify environment
Rscript R/check_repro.R
```

### Obtain Raw Data

Run `Rscript data-raw/get_data.R` to see detailed instructions for each dataset. In summary:

1. **eBird data** — download from [ebird.org/data/download](https://ebird.org/data/download) (requires account + license agreement)
2. **Bioclimatic rasters** — WorldClim v2.1
3. **Topographic rasters** — SRTM-derived
4. **GEE dynamic variables** — export via `scripts/3_download_dynamic_variables_{sp}.js`
5. **Validation atlas** — Spanish Biodiversity Atlas (MITECO)

### Run the Full Pipeline

```bash
Rscript R/run_all.R
```

This generates all figures in `figs/`, all results in `results/`, and session info for verification.

## Pipeline

```
eBird raw data (~38 GB)
    │
    ▼
[Step 1] Filter by species, dates, protocols → zero-filled detection histories
    │
    ▼
[Step 2] Extract bioclimatic + topographic covariates → wide-format datasets
    │     Saves scaling parameters for reproducible prediction
    │
    ▼
[Step 3a] Google Earth Engine (manual): extract NDVI, EVI, land cover, climate
[Step 3b] Merge GEE exports into wide-format dataset
    │
    ▼
[Step 4] Build unmarkedMultFrame → fit colext() models per species
    │     • GOF: parametric bootstrap (n=1000) + MacKenzie-Bailey (n=500)
    │     • Response curves for ψ, γ, ε, p
    │     • Spatial occupancy maps (prediction with training-consistent scaling)
    │     • Stochastic simulations (n=5000) of occupancy trends
    │
    ▼
[Step 5] Validate against Spanish Biodiversity Atlas
         • Spatial block CV (blockCV, k=5)
         • AUC, TSS, RMSE, Spearman correlation
         • Moran's I on residuals
```

## Key Design Decisions

| Decision | Rationale |
|----------|-----------|
| `colext()` dynamic occupancy | Accounts for imperfect detection; models colonisation and extinction separately |
| eBird citizen science data | Largest available dataset for steppe birds in Spain |
| Spatial block CV for validation | Avoids spatial autocorrelation bias in model evaluation |
| Scaling parameters saved and reused | Ensures prediction surface uses same standardisation as training data |
| `set.seed()` before every stochastic step | All simulations, bootstraps, and CV are fully reproducible |
| GOF nsim >= 500 | Publication-grade goodness-of-fit assessment |

## Model Specifications

Model formulas are defined in `R/model_configs.R`. Each species has independently selected covariates for:

- **Initial occupancy (ψ):** bioclimatic + topographic variables
- **Colonisation (γ):** NDVI, land cover, temperature, precipitation
- **Extinction (ε):** land cover change, temperature extremes
- **Detection (p):** survey effort, time of day, number of observers

Model selection was based on AIC comparison. See `results/{sp}_model_summary.txt` for coefficient estimates and AIC values.

## Reproducibility

See [REPRODUCIBILITY.md](REPRODUCIBILITY.md) for:
- System requirements and installation
- Data acquisition guide
- Output verification
- Random seed documentation
- Data & Code Availability statement (ready to paste into paper)

## Citation

> [Authors]. (2026). Dynamic occupancy models reveal steppe bird decline in Spain. *[Journal]*. Code and data: https://github.com/<user>/dynamic_occupancy_models_steppe_birds

## License

Code: MIT License
Data: Subject to original data provider licenses (eBird, WorldClim, MODIS, MITECO).
