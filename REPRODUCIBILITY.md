# Reproducibility Guide

## System Requirements

### R
- **R >= 4.3** recommended (tested on R 4.x)
- All packages are managed via `renv` (see below)

### System libraries (required by `sf` and `terra`)

| Library | Minimum Version | Purpose |
|---------|----------------|---------|
| GDAL    | >= 3.4         | Raster/vector I/O |
| GEOS    | >= 3.9         | Geometry operations |
| PROJ    | >= 8.0         | Coordinate reference systems |

#### Install system dependencies

**macOS (Homebrew):**
```bash
brew install gdal geos proj
```

**Ubuntu/Debian:**
```bash
sudo apt-get update
sudo apt-get install -y libgdal-dev libgeos-dev libproj-dev libudunits2-dev
```

**Fedora/RHEL:**
```bash
sudo dnf install gdal-devel geos-devel proj-devel udunits2-devel
```

**Windows:**
System libraries are bundled with the R packages — no extra installation needed.

### Google Earth Engine (for Step 3a only)
- A GEE account is required to run the dynamic variable extraction scripts.
- These are JavaScript scripts run in the [GEE Code Editor](https://code.earthengine.google.com/).
- Pre-exported CSV outputs can be provided to skip this step.

---

## Installation

```bash
# 1. Clone the repository
git clone https://github.com/<user>/dynamic_occupancy_models_steppe_birds.git
cd dynamic_occupancy_models_steppe_birds

# 2. Open R in the project root
R

# 3. Restore the exact package environment
renv::restore()

# 4. Verify your setup
source("R/check_repro.R")
```

---

## Data Setup

Raw data must be placed manually before running the pipeline.
See `data-raw/get_data.R` for detailed instructions.

```
data/
├── raw/
│   ├── ebird_raw_mar2024/          # eBird Basic Dataset (manual download)
│   │   ├── ebd_ES_smp_relMar-2024.txt
│   │   └── ebd_sampling_relMar-2024.txt
│   ├── environmental_data/
│   │   └── environmental_data_occ/
│   │       ├── variables_spain.grd  # WorldClim BioClim stack
│   │       └── variables_spain.gri
│   ├── topology_data/               # SRTM-derived topography
│   │   ├── topo_aspect.asc
│   │   ├── topo_elev.asc
│   │   ├── topo_slope.asc
│   │   ├── topo_aspect_masked.tif
│   │   └── topo_elev_masked.tif
│   ├── gee_exports/                 # Google Earth Engine outputs
│   │   ├── otitar_dynamic_variables.csv
│   │   ├── ptealc_dynamic_variables.csv
│   │   ├── pteori_dynamic_variables.csv
│   │   └── tettet_dynamic_variables.csv
│   └── validation/
│       └── atlas_biodiversidad/
│           └── aves_spain.shp       # Spanish Biodiversity Atlas
└── processed/                       # Generated by pipeline (do not edit)
```

---

## One Command to Run

```bash
Rscript R/run_all.R
```

This executes the full pipeline:

| Step | Script | Description | Time* |
|------|--------|-------------|-------|
| 1 | `1_prepare_database_ebird.R` | Filter eBird data per species | ~30 min |
| 2 | `2_prepare_static_variables.R` | Extract bioclimatic + topographic covariates | ~20 min |
| 3a | `3_download_dynamic_variables_{sp}.js` | GEE: extract NDVI, land cover, climate (manual) | ~10 min/sp |
| 3b | `3_prepare_dynamic_variables.R` | Merge GEE exports with static data | ~2 min |
| 4 | `4_occupancy_models.R` | Fit `colext()` models, GOF, maps, simulations | ~4-8 h |
| 5 | `5_validation.R` | Spatial block CV against atlas | ~30 min |

*Approximate times on a modern laptop (M1/i7, 16 GB RAM).

### Outputs

```
figs/                          # All figures (PNG)
├── {species}_response_occupancy.png
├── {species}_response_colonization.png
├── {species}_response_extinction.png
├── {species}_response_detection.png
├── {species}_occupancy_map.png
├── {species}_prevalence_over_time.png
├── {species}_validation_calibration.png
├── {species}_validation_residuals_map.png
└── {species}_validation_maps.png

results/                       # Model outputs and summaries
├── {species}_model_summary.txt
├── {species}_model_object.rds
├── {species}_gof_parboot.rds
├── {species}_gof_mackenzie_bailey.rds
├── {species}_simulation_prevalence.csv
├── {species}_validation_cv.csv
├── {species}_validation_summary.txt
└── session_info.txt
```

---

## Verifying Reproducibility

After running the pipeline, you can verify:

```r
# Check that key outputs exist
list.files("figs/", pattern = "\\.png$")
list.files("results/", pattern = "\\.(txt|csv|rds)$")

# Compare session info
cat(readLines("results/session_info.txt"), sep = "\n")
```

---

## Random Seeds

All stochastic operations use fixed seeds for reproducibility:

| Operation | Seed | Script |
|-----------|------|--------|
| Repeat visit filtering | `set.seed(1)` | `2_prepare_static_variables.R` |
| GOF parametric bootstrap | `set.seed(42)` | `4_occupancy_models.R` |
| MacKenzie-Bailey GOF | `set.seed(42)` | `4_occupancy_models.R` |
| Stochastic simulations | `set.seed(123)` | `4_occupancy_models.R` |
| Spatial block CV | `set.seed(123)` | `5_validation.R` |

---

## Data & Code Availability Statement (for paper)

> The R code to reproduce all analyses is available at
> https://github.com/<user>/dynamic_occupancy_models_steppe_birds.
> Raw eBird data were obtained from the eBird Basic Dataset
> (https://ebird.org/data/download; Cornell Lab of Ornithology) under
> their terms of use and cannot be redistributed. Bioclimatic variables
> were obtained from WorldClim v2.1 (Fick & Hijmans, 2017). Land cover,
> NDVI, and climate variables were extracted from MODIS and TerraClimate
> collections via Google Earth Engine (Gorelick et al., 2017). The
> Spanish Biodiversity Atlas data used for validation were obtained from
> the Inventario Espanol del Patrimonio Natural y la Biodiversidad
> (MITECO). Processed intermediate datasets sufficient to reproduce
> Steps 3b–5 are deposited on Zenodo (DOI: <PENDING>).
